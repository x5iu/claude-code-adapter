name: Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy (e.g. v0.8.3), leave empty for latest"
        required: false
        type: string

concurrency:
  group: deploy
  cancel-in-progress: false

env:
  BINARY_NAME: claude-code-adapter

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: api.claude-code-adapter.com
    steps:
      - name: Determine version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ -n "${INPUT_VERSION}" ]; then
            if ! echo "${INPUT_VERSION}" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.+-]+)?$'; then
              echo "Error: Invalid version format '${INPUT_VERSION}'. Expected vX.Y.Z (e.g. v0.8.3)"
              exit 1
            fi
            VERSION="${INPUT_VERSION}"
            echo "Using specified version: ${VERSION}"
          else
            VERSION=$(gh release view --json tagName -q '.tagName')
            echo "Using latest version: ${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download binary from release
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARTIFACT_NAME="${{ env.BINARY_NAME }}-linux-amd64-${VERSION}"
          echo "Downloading ${ARTIFACT_NAME}..."
          gh release download "${VERSION}" --pattern "${ARTIFACT_NAME}" -D .
          chmod +x "${ARTIFACT_NAME}"
          ls -lh "${ARTIFACT_NAME}"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.DEPLOY_PORT || 22 }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to server
        env:
          SSH_KEY: ~/.ssh/deploy_key
          SSH_USER: ${{ secrets.DEPLOY_USER }}
          SSH_HOST: ${{ secrets.DEPLOY_HOST }}
          SSH_PORT: ${{ secrets.DEPLOY_PORT || 22 }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARTIFACT_NAME="${{ env.BINARY_NAME }}-linux-amd64-${VERSION}"
          SSH_TARGET="$SSH_USER@$SSH_HOST"

          set -x

          echo "==> Checking if binary exists..."
          if [ ! -f "${ARTIFACT_NAME}" ]; then
            echo "Error: Binary '${ARTIFACT_NAME}' not found"
            exit 1
          fi

          echo "==> Uploading binary..."
          scp -i $SSH_KEY -P $SSH_PORT -o StrictHostKeyChecking=yes -o ConnectTimeout=30 "${ARTIFACT_NAME}" $SSH_TARGET:/tmp/${{ env.BINARY_NAME }}.new

          echo "==> Deploying on server..."
          ssh -i $SSH_KEY -p $SSH_PORT -o StrictHostKeyChecking=yes -o ConnectTimeout=30 $SSH_TARGET << DEPLOY_SCRIPT
            set -e

            BINARY_NAME="${{ env.BINARY_NAME }}"
            DEPLOY_PATH="${DEPLOY_PATH}"
            SERVICE_NAME="${SERVICE_NAME}"

            mkdir -p \$(dirname \$DEPLOY_PATH)

            if [ -f "\$DEPLOY_PATH" ]; then
              cp "\$DEPLOY_PATH" "\${DEPLOY_PATH}.backup"
              echo "Backed up existing binary"
            fi

            echo "Stopping service..."
            systemctl stop \$SERVICE_NAME || true

            mv /tmp/\${BINARY_NAME}.new \$DEPLOY_PATH
            chmod +x \$DEPLOY_PATH

            echo "Starting service..."
            systemctl start \$SERVICE_NAME

            sleep 3
            if systemctl is-active --quiet \$SERVICE_NAME; then
              echo "Service started successfully"
              systemctl status \$SERVICE_NAME --no-pager
            else
              echo "ERROR: Service failed to start!"
              systemctl status \$SERVICE_NAME --no-pager || true
              journalctl -u \$SERVICE_NAME -n 50 --no-pager || true
              exit 1
            fi
          DEPLOY_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ secrets.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
